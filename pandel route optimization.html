<!--
  © 2025 Bappa Bain. All rights reserved.

  This file is proprietary and protected under international copyright laws.

for adding pandels contact me on linklib25@gmail.com or insta: bappabain5
-->


<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>durga pandel hopping route plannar</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script defer src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>




    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            padding: 0;
            background: #f5f5f5;
        }

        h3 {
            margin-bottom: 5px;
        }

        input[type="text"] {
            width: 100%;
            max-width: 400px;
            padding: 6px 8px;
            font-size: 14px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        button {
            padding: 8px 16px;
            font-size: 14px;
            margin: 10px 0;
            cursor: pointer;
            background: #246;
            color: #fff;
            border: none;
            border-radius: 4px;
        }

        button:hover {
            background: #135;
        }

        .search-wrapper {
            position: relative;
            display: inline-block;
        }



        .clear-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 30px;
            color: #888;
            cursor: pointer;
            display: none;
            /* hidden until text is entered */
        }

        .clear-btn:hover {
            color: #000;
        }

        #pandalSearch {
            width: 100%;
            max-width: 400px;
            padding: 6px 8px;
            font-size: 14px;
            margin-bottom: 8px;
            box-sizing: border-box;
        }

        #pandalList {
            margin-bottom: 10px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 6px;
            background: #fff;
        }

        #pandalList label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        #output {
            background: #fff;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            margin-top: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
        }

        canvas {
            border: 1px solid #333;
            background: #fafafa;
            width: 100%;
            max-width: 600px;
            height: 400px;
            margin-top: 10px;
            border-radius: 6px;
        }

        @media (max-width: 500px) {
            canvas {
                height: 300px;
            }

            #output {
                font-size: 12px;
            }

            button {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
    </style>
</head>

<body>
    <h3>Select Pandals:</h3>
    <label for="regionFilter">Filter by region:</label>
    <select id="regionFilter">
        <option value="all">All</option>
        <option value="North + salt Lake">North + Salt Lake</option>
        <option value="south">South</option>
    </select>
    <br><br>
    <div class="search-wrapper">
        <input id="pandalSearch" type="text" placeholder="Search pandals...">
        <span class="clear-btn" id="clearSearch">×</span>
    </div>

    <div id="pandalList"></div>

    <h3>Set Start Location (drop pin)</h3>
    <input id="homeCoord" type="text" style="display: none;" placeholder="Search home location..."
        style="max-width:400px; margin-bottom:8px;">


    <div id="map" style="height:300px; max-width:600px; border:1px solid #666; border-radius:6px;"></div>


    <button onclick="runTSP()">Compute Best Route</button>


    <pre id="output"></pre>
    <br>
    <p>for adding pandels contact me on linklib25@gmail.com or insta: bappabain5</p>
    <br><br>

    <!-- Leaflet + GeoSearch -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@latest/dist/geosearch.css" />
    <script src="https://unpkg.com/leaflet-geosearch@latest/dist/bundle.min.js"></script>

    <script>
        /* ---------- Map + search already present above this script in your HTML ---------- */
        /* This script expects: Leaflet, leaflet-geosearch, and Leaflet Routing Machine loaded. */


        // map already created in your page: keep same center/zoom
        const map = L.map("map").setView([22.608, 88.374], 10);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "© OpenStreetMap contributors"
        }).addTo(map);

        // ---------- Icons ----------
        const homeIcon = L.icon({
            iconUrl: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -28]
        });

        const selectedIcon = L.icon({
            iconUrl: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -28]
        });

        // ---------- Global state ----------
        let homeMarker = null;
        const pandalMarkers = {};      // name -> marker (only for selected pandals)
        let routeControl = null;      // L.Routing.control instance
        const selectedPandals = new Set();

        // ---------- Home selection: click map or use search (leaflet-geosearch control assumed added already) ----------
        // clicking map places/updates a draggable home marker
        map.on("click", function (e) {
            const { lat, lng } = e.latlng;
            setHomeMarker([lat, lng]);
        });

        function setHomeMarker([lat, lng]) {
            document.getElementById("homeCoord").value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

            if (homeMarker) {
                homeMarker.setLatLng([lat, lng]);
            } else {
                homeMarker = L.marker([lat, lng], { icon: homeIcon, draggable: true }).addTo(map);
                homeMarker.bindPopup("Home").openPopup();
                homeMarker.on("dragend", function (ev) {
                    const pos = ev.target.getLatLng();
                    document.getElementById("homeCoord").value = `${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)}`;
                });
            }
        }

        const searchInput = document.getElementById("pandalSearch");
        const clearBtn = document.getElementById("clearSearch");

        // Show or hide clear button
        searchInput.addEventListener("input", () => {
            clearBtn.style.display = searchInput.value ? "block" : "none";
        });

        // Clear field on click
        clearBtn.addEventListener("click", () => {
            searchInput.value = "";
            clearBtn.style.display = "none";
            searchInput.focus();
            // Trigger your pandal filter rerender
            renderPandals("");
        });

        // If leaflet-geosearch used, listen for 'geosearch/showlocation' (some versions emit this)


        map.on('geosearch/showlocation', function (result) {
            if (result && result.location) {
                const { y: lat, x: lng } = result.location;
                map.setView([lat, lng], 13);
                setHomeMarker([lat, lng]);
            }
        });

        // ---------- Data (your pandals) ----------
        const rawPoints = [
            { name: "Home", coord: "22.65372299907361, 88.38037958252858", type: "home" }, // default home coords
            { name: "Kumortuli Park", coord: "22.59917087510497, 88.36147702405188", type: "place", reigon: "North + salt Lake" },
            { name: "Bagbazar", coord: "22.60472739073317, 88.36558280871148", type: "place", reigon: "North + salt Lake" },
            { name: "Ahiritola", coord: "22.597727677079043, 88.35509096822754", type: "place", reigon: "North + salt Lake" },
            { name: "shreebhumi", coord: "22.60059328304392, 88.4025723798762", type: "place", reigon: "North + salt Lake" },
            { name: "santosh mitra", coord: "22.566297486742428, 88.36562100871039", type: "place", reigon: "North + salt Lake" },
            { name: "Newtown Sarbojonin", coord: "22.582082636124365, 88.45892976638112", type: "place", reigon: "North + salt Lake" },
            { name: "College Square", coord: "22.574640189807663, 88.36444006865979", type: "place", reigon: "North + salt Lake" },
            { name: "sodepur nabaday sangha", coord: "22.704162932602696, 88.3776406320563", type: "place", reigon: "North + salt Lake" },
            { name: "sodepur sahid colony", coord: "22.695333094167463, 88.3763842252182", type: "place", reigon: "North + salt Lake" },
            { name: "sodepur dakshin pally", coord: "22.698673415932312, 88.3862698359085", type: "place", reigon: "North + salt Lake" },
            { name: "Ghola ramkrisna park", coord: "22.696194071764868, 88.39989566064249", type: "place", reigon: "North + salt Lake" },
            { name: "sodepur bijoypur sarbajonin", coord: "22.694456080442958, 88.39157371144043", type: "place", reigon: "North + salt Lake" },
            { name: "agarpara tarapukur pachimpally", coord: "22.68778533926442, 88.38551752749423", type: "place", reigon: "North + salt Lake" },
            { name: "7 tanks", coord: "22.624134215514147, 88.38886884908621", type: "place", reigon: "North + salt Lake" },
            { name: "sinthee roy", coord: "22.627285818307797, 88.3895632747805", type: "place", reigon: "North + salt Lake" },
            { name: "dum dum park", coord: "22.60956206771255, 88.41638619925284", type: "place", reigon: "North + salt Lake" },
            { name: "Lake town adibasi brinda", coord: "22.60539130075984, 88.40361677726241", type: "place", reigon: "North + salt Lake" },
            { name: "Jagarani sangha bidhannagar", coord: "22.5933018582821, 88.38488324928673", type: "place", reigon: "North + salt Lake" },
            { name: "gauri bari sarbojanin", coord: "22.595412210047172, 88.37938195258563", type: "place", reigon: "North + salt Lake" },
            { name: "sovabazar rajbari", coord: "22.596524548772628, 88.36730974941005", type: "place", reigon: "North + salt Lake" },
            { name: "kasi bose lane", coord: "22.591036608009865, 88.368782230229", type: "place", reigon: "North + salt Lake" },
            { name: "hati bagan sarbojanin", coord: "22.594500697512014, 88.37198610863811", type: "place", reigon: "North + salt Lake" },
            { name: "beliaghata 33 no", coord: "22.569223176730944, 88.39137140197289", type: "place", reigon: "North + salt Lake" },
            { name: "mitali sangha kakurgachhi", coord: "22.580450303806412, 88.39431969614033", type: "place", reigon: "North + salt Lake" },
            { name: "labony estate EB salt lake", coord: "22.58368015905083, 88.40686508752925", type: "place", reigon: "North + salt Lake" },
            { name: "bhawanipur sarbojanin", coord: "22.53560207841347, 88.34383188252696", type: "place", reigon: "south" },
            { name: "68 pally", coord: "22.529382214925672, 88.34624456834595", type: "place", reigon: "south" },
            { name: "64 pally", coord: "22.521132979859964, 88.34754093685497", type: "place", reigon: "south" },
            { name: "chetla agrani", coord: "22.516779580350747, 88.33705372142953", type: "place", reigon: "south" },
            { name: "deshapriya park", coord: "22.519982550576906, 88.35381980148239", type: "place", reigon: "south" },
            { name: "singhi park sarbojanin", coord: "22.521320478183203, 88.36294897596144", type: "place", reigon: "south" },
            { name: "bosepukur talbagan", coord: "22.51921222266767, 88.38287515668235", type: "place", reigon: "south" },
            { name: "shakti sangha club", coord: "22.505972406447967, 88.38778242658351", type: "place", reigon: "south" },
            { name: "jodhpur park", coord: "22.5055041149551, 88.36547179911918", type: "place", reigon: "south" },
            { name: "mudiali club", coord: "22.51103911715562, 88.34610673466848", type: "place", reigon: "south" },
            { name: "taltala", coord: "22.503972066123165, 88.36418792668916", type: "place", reigon: "south" },
            { name: "newland durga puja", coord: "22.50544140212769, 88.23053369024893", type: "place", reigon: "south" },
            { name: "buro shibtala", coord: "22.505805581033794, 88.33023488197182", type: "place", reigon: "south" },
            { name: "29 pally", coord: "22.508423061604812, 88.32267945234385", type: "place", reigon: "south" },
            { name: "khidirpur 25 pally", coord: "22.540265105215475, 88.32563079056149", type: "place", reigon: "south" },
            { name: "hazra park", coord: "22.525193965479087, 88.3460508123787", type: "place", reigon: "south" },
            { name: "golf green", coord: "22.496101424812682, 88.36326381259857", type: "place", reigon: "south" },
            { name: "suruchi sangha", coord: "22.509059292566267, 88.33394759422455", type: "place", reigon: "south" }

        ];

        const points = rawPoints.map(p => {
            const [lat, lng] = p.coord.split(",").map(v => parseFloat(v.trim()));
            return { ...p, lat, lng };
        });

        // set initial home marker (from default)
        const initialHome = points.find(p => p.type === "home");
        if (initialHome) setHomeMarker([initialHome.lat, initialHome.lng]);

        // ---------- TSP helpers (keep your haversine + permutations logic) ----------
        function toRad(deg) { return deg * Math.PI / 180; }
        function haversine(a, b) {
            const R = 6371;
            const dLat = toRad(b.lat - a.lat), dLon = toRad(b.lng - a.lng);
            const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
            const h = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h));
        }
        function permutations(arr) {
            const res = [], a = arr.slice();
            function swap(i, j) { [a[i], a[j]] = [a[j], a[i]]; }
            function generate(n) {
                if (n === 1) { res.push(a.slice()); return; }
                for (let i = 0; i < n; i++) { generate(n - 1); swap(n % 2 ? 0 : i, n - 1); }
            }
            generate(a.length);
            return res;
        }
        function solveTSP(pointsList) {
            const home = pointsList.find(p => p.type === "home");
            const places = pointsList.filter(p => p.type !== "home");
            if (places.length === 0) return null;
            let best = null;
            for (const perm of permutations(places)) {
                let d = haversine(home, perm[0]);
                for (let i = 0; i < perm.length - 1; i++) d += haversine(perm[i], perm[i + 1]);
                d += haversine(perm[perm.length - 1], home);
                if (!best || d < best.dist) best = { order: [home, ...perm, home], dist: d };
            }
            return best;
        }

        // ---------- Routing on map (sequential a->b->c->...) ----------
        function clearRoute() {
            if (routeControl) {
                map.removeControl(routeControl);
                routeControl = null;
            }
        }


        let selectedMarkers = [];


        function drawRouteOnMap(order) {
            if (routeControl) {
                map.removeControl(routeControl);
            }

            const waypoints = order.map(p => L.latLng(p.lat, p.lng));

            routeControl = L.Routing.control({
                waypoints: waypoints,
                lineOptions: {
                    styles: [{ color: '#246', weight: 5, opacity: 0.9 }]
                },
                show: false,
                addWaypoints: false,
                draggableWaypoints: false,
                fitSelectedRoutes: true,
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    profile: 'cycling' // change to 'driving' if you want car routes
                }),
                createMarker: function (i, wp, nWps) {
                    const point = order[i];
                    if (point.type === "home") {
                        return L.marker(wp.latLng, { icon: homeIcon }).bindPopup(point.name);
                    } else {
                        return L.marker(wp.latLng, { icon: selectedIcon }).bindPopup(point.name);
                    }
                }
            }).addTo(map);

            // ✅ Listen for route calculation and show real distance
            routeControl.on("routesfound", function (e) {
                const route = e.routes[0];
                const distKm = (route.summary.totalDistance / 1000).toFixed(2);
                // const timeMin = Math.round(route.summary.totalTime / 60);
                const timeMin = distKm * 3; // approx 20 km/h scooter avg speed
                const timeStr = timeMin < 60 ? `${Math.round(timeMin)} min` : `${Math.floor(timeMin / 60)} hr ${Math.round(timeMin % 60)} min`;

                // Append/replace in the output box
                const output = document.getElementById("output");
                //output.innerHTML += `<br><b>Total routed distance:</b> ${distKm} km<br><b>Estimated time:</b> ${timeMin} min`;
                // Replace only the distance/time section, keep the route sequence intact
                output.innerHTML = output.innerHTML.replace(/<br><b>Total routed distance:[\s\S]*/, "");
                output.innerHTML += `<br><br><b>Total routed distance:</b> ${distKm} km<br><b>Estimated time:</b> ${timeStr}`;

            });
        }



        // ---------- UI: pandal list, selection persistence, and marker creation only for selected ----------
        const listDiv = document.getElementById("pandalList");
        const searchBox = document.getElementById("pandalSearch");

        // helper: create marker for a pandal (when selected)
        function createPandalMarker(p) {
            if (pandalMarkers[p.name]) return; // already created
            const m = L.marker([p.lat, p.lng], { icon: selectedIcon }).addTo(map).bindPopup(p.name);
            // clicking the marker will deselect (and remove marker) to keep UX simple
            m.on("click", () => {
                // remove selection
                selectedPandals.delete(p.name);
                // remove marker
                if (pandalMarkers[p.name]) {
                    map.removeLayer(pandalMarkers[p.name]);
                    delete pandalMarkers[p.name];
                }
                // update checkbox UI
                renderPandals(searchBox.value.trim());
            });
            pandalMarkers[p.name] = m;
        }

        function removePandalMarkerByName(name) {
            if (pandalMarkers[name]) {
                map.removeLayer(pandalMarkers[name]);
                delete pandalMarkers[name];
            }
        }

        // Render the checkbox list (filtering + checked state)
        function renderPandals(filter = "") {
            listDiv.innerHTML = "";
            const region = document.getElementById("regionFilter").value;

            points.filter(p => p.type !== "home").forEach((p, i) => {
                const matchesRegion = (region === "all" || p.reigon === region);
                const matchesFilter = p.name.toLowerCase().includes(filter.toLowerCase());

                if (matchesRegion && matchesFilter) {
                    const id = "chk" + i;
                    const isChecked = selectedPandals.has(p.name) ? "checked" : "";
                    //listDiv.innerHTML += `<label><input type="checkbox" id="${id}" data-name="${p.name}" ${isChecked}> ${p.name}</label>`;
                    listDiv.innerHTML += `
                                            <label>
                                                <input type="checkbox" id="${id}" data-name="${p.name}" ${isChecked}>
                                                ${p.name}
                                                <a href="https://www.google.com/search?tbm=isch&q=${encodeURIComponent(p.name + ' Durga Puja 2025 youtube')}" target="_blank" title="View images">
                                                <img src="durga.jpg" alt="Durga" style="width:18px;height:18px;margin-left:6px;vertical-align:middle;cursor:pointer;">
                                                </a>
                                            </label>
                                            `;


                }
            });


            // attach listeners
            document.querySelectorAll("#pandalList input[type=checkbox]").forEach(chk => {
                const newChk = chk.cloneNode(true);
                chk.parentNode.replaceChild(newChk, chk);

                newChk.addEventListener("change", (e) => {
                    const name = e.target.dataset.name;
                    const pandal = points.find(pt => pt.name === name);
                    if (!pandal) return;

                    if (e.target.checked) {
                        selectedPandals.add(name);
                        createPandalMarker(pandal);
                    } else {
                        selectedPandals.delete(name);
                        removePandalMarkerByName(name);
                    }
                });
            });
        }


        // initial render (all pandals shown in list)
        renderPandals();

        document.getElementById("regionFilter").addEventListener("change", () => {
            renderPandals(searchBox.value.trim());
        });


        // search listener
        searchBox.addEventListener("input", () => {
            const val = searchBox.value.trim();
            renderPandals(val);
        });

        // ---------- Main: compute and draw TSP route ----------
        document.querySelector("button[onclick='runTSP()']")?.addEventListener("click", runTSP);

        function runTSP() {
            const val = document.getElementById("homeCoord").value.trim();
            if (!val) {
                document.getElementById("output").innerHTML = "Please set home by clicking map or using search.";
                return;
            }
            const [lat, lng] = val.split(",").map(v => parseFloat(v.trim()));
            if (isNaN(lat) || isNaN(lng)) {
                document.getElementById("output").innerHTML = "Home coordinates invalid.";
                return;
            }

            // update home in points array
            points.forEach(p => { if (p.type === "home") { p.lat = lat; p.lng = lng; p.coord = `${lat}, ${lng}`; } });

            // Build selected points list: home + selected pandals
            const selected = points.filter(p => p.type === "home" || selectedPandals.has(p.name));

            if (selected.length <= 1) {
                document.getElementById("output").innerHTML = "Please select at least one pandal.";
                return;
            }

            // Solve TSP (brute-force)
            const best = solveTSP(selected);
            if (!best) {
                document.getElementById("output").innerHTML = "No route found.";
                return;
            }

            // show sequence + total distance
            let html = "Best sequence:<br>";

            for (let i = 0; i < best.order.length; i++) {
                const stop = best.order[i];

                // Name link: from CURRENT LOCATION → this pandal
                const nameGmapUrl = `https://www.google.com/maps/dir/?api=1&destination=${stop.lat},${stop.lng}&travelmode=driving`;
                html += `<a href="${nameGmapUrl}" target="_blank" style="text-decoration:none; font-weight:bold; ">${stop.name}</a>`;

                // Arrow link: from previous pandal → next pandal
                if (i < best.order.length - 1) {
                    const fromLat = stop.lat;
                    const fromLng = stop.lng;
                    const toLat = best.order[i + 1].lat;
                    const toLng = best.order[i + 1].lng;
                    const arrowGmapUrl = `https://www.google.com/maps/dir/${fromLat},${fromLng}/${toLat},${toLng}`;
                    html += ` <a href="${arrowGmapUrl}" target="_blank" style="text-decoration:none; font-weight:bold; color:#1E90FF;">➡️</a> `;
                }
            }

            document.getElementById("output").innerHTML = html;


            // ensure markers exist for all selected pandals (they should already if selected via checkboxes)
            // create if not present (defensive)
            best.order.forEach(p => {
                if (p.type !== "home" && selectedPandals.has(p.name) && !pandalMarkers[p.name]) {
                    createPandalMarker(p);
                }
            });

            // draw road route on map (sequential through the TSP order)
            drawRouteOnMap(best.order);
        }

        // expose runTSP if needed
        window.runTSP = runTSP;


    </script>

</body>

</html>
